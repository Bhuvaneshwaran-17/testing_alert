name: Integrated Multi-Task Pipeline
on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  TEAMS_URL: ${{ secrets.TESTING_WEBHOOK }}

jobs:
  Task_1_Build_Monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Run Build
        run: |
          echo "Simulating Build Failure..."
          exit 1
          
      - name: Alert Task 1 Failure
        if: failure()
        run: |
          curl -H 'Content-Type: application/json' \
          -d "{\"text\": \"ðŸš¨ Task 1 Failed: Build Error in ${{ github.repository }}\"}" $TEAMS_URL

  Task_2_Env_Check:
    runs-on: ubuntu-latest
    needs: Task_1_Build_Monitor
    if: always() # <--- CRITICAL: Runs even if Task 1 failed
    steps:
      - name: Check Secret
        run: |
          if [ -z "${{ secrets.MANDATORY_CONFIG_VAR }}" ]; then
            echo "MANDATORY_CONFIG_VAR is missing"
            exit 1
          fi
      - name: Alert Task 2 Failure
        if: failure()
        run: |
          curl -H 'Content-Type: application/json' \
          -d "{\"text\": \"ðŸš¨ Task 2 Failed: Secret Missing in ${{ github.repository }}\"}" $TEAMS_URL

  Task_3_Config_Check:
    runs-on: ubuntu-latest
    needs: Task_2_Env_Check
    if: always() # <--- CRITICAL: Runs even if Task 2 failed
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Check appsettings.json
        run: |
          if [ ! -f appsettings.json ]; then
            echo "File not found"
            exit 1
          fi
      - name: Alert Task 3 Failure
        if: failure()
        run: |
          curl -H 'Content-Type: application/json' \
          -d "{\"text\": \"ðŸš¨ Task 3 Failed: File Missing in ${{ github.repository }}\"}" $TEAMS_URL
